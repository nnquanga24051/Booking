@model List<Booking_Hotel.Models.Room>

@{
    ViewData["Title"] = "Booking";
}

@section Styles {
    <link rel="stylesheet" href="~/css/booking.css" asp-append-version="true" />
}

<section class="booking-hero">
    <div class="booking-hero-overlay"></div>
    <div class="booking-hero-content">
        <h1 class="booking-hero-title">Đặt Phòng Khách Sạn</h1>
        <p class="booking-hero-subtitle">Tìm và đặt phòng lý tưởng của bạn</p>
    </div>
</section>

<section class="booking-container">
    <div class="container">
        @if (TempData["ErrorMessage"] != null)
        {
            <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                ⚠️ @TempData["ErrorMessage"]
            </div>
        }

        @if (Context.Session.GetInt32("UserId") == null)
        {
            <div style="background: #fff3cd; color: #856404; padding: 15px; border-radius: 5px; margin-bottom: 20px; text-align: center;">
                ⚠️ Bạn cần <a href="/Authentications/Login" style="color: #0066a1; font-weight: bold;">đăng nhập</a> để có thể đặt phòng.
                Chưa có tài khoản? <a href="/Authentications/Register" style="color: #0066a1; font-weight: bold;">Đăng ký ngay</a>
            </div>
        }

        <div class="booking-layout">
            <aside class="filter-sidebar">
                <div class="filter-card">
                    <h3 class="filter-title">🔍 Bộ Lọc Tìm Kiếm</h3>

                    <form id="filterForm" method="get" action="/Home/Booking">
                        <div class="filter-group">
                            <label class="filter-label">📍 Chi Nhánh</label>
                            <select name="branch" class="filter-select">
                                <option value="">Tất cả chi nhánh</option>
                                @if (ViewBag.Branches != null)
                                {
                                    foreach (var b in ViewBag.Branches)
                                    {
                                        <option value="@b.BranchId"
                                                selected="@(ViewBag.SelectedBranch == b.BranchId.ToString() ? "selected" : null)">
                                            @b.BranchName
                                        </option>
                                    }
                                }
                            </select>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">🏨 Loại Phòng</label>
                            <select name="roomType" class="filter-select">
                                <option value="">Tất cả loại phòng</option>
                                <option value="Standard" selected="@(ViewBag.SelectedRoomType == "Standard" ? "selected" : null)">
                                    Standard - Tiêu chuẩn
                                </option>
                                <option value="Deluxe" selected="@(ViewBag.SelectedRoomType == "Deluxe" ? "selected" : null)">
                                    Deluxe - Cao cấp
                                </option>
                                <option value="Suite" selected="@(ViewBag.SelectedRoomType == "Suite" ? "selected" : null)">
                                    Suite - VIP
                                </option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">📅 Ngày Nhận Phòng</label>
                            <input type="date" name="checkin" class="filter-input"
                                   value="@ViewBag.SelectedCheckin"
                                   min="@DateTime.Now.ToString("yyyy-MM-dd")" />
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">📅 Ngày Trả Phòng</label>
                            <input type="date" name="checkout" class="filter-input"
                                   value="@ViewBag.SelectedCheckout"
                                   min="@DateTime.Now.AddDays(1).ToString("yyyy-MM-dd")" />
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">💰 Khoảng Giá (VNĐ)</label>
                            <div class="price-inputs">
                                <input type="number" name="minPrice" placeholder="Từ"
                                       class="filter-input"
                                       value="@ViewBag.SelectedMinPrice"
                                       step="100000" />
                                <span class="price-separator">-</span>
                                <input type="number" name="maxPrice" placeholder="Đến"
                                       class="filter-input"
                                       value="@ViewBag.SelectedMaxPrice"
                                       step="100000" />
                            </div>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">📊 Trạng Thái</label>
                            <div class="checkbox-group">
                                @{
                                    var selectedStatus = ViewBag.SelectedStatus as string[] ?? new string[] { "available" };
                                    bool availableChecked = selectedStatus.Contains("available") || selectedStatus.Length == 0;
                                    bool maintenanceChecked = selectedStatus.Contains("maintenance");
                                }
                                <label class="checkbox-label">
                                    <input type="checkbox" name="status" value="available"
                                           @(availableChecked ? "checked" : "") />
                                    <span>Còn trống</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="status" value="maintenance"
                                           @(maintenanceChecked ? "checked" : "") />
                                    <span>Bảo trì</span>
                                </label>
                            </div>
                        </div>

                        <div class="filter-actions">
                            <button type="submit" class="filter-btn primary">
                                🔍 Tìm Kiếm
                            </button>
                            <a href="/Home/Booking" class="filter-btn secondary" style="text-decoration: none; text-align: center;">
                                🔄 Đặt Lại
                            </a>
                        </div>
                    </form>
                </div>

                <div class="info-card">
                    <h4 class="info-title">💡 Thông Tin Hữu Ích</h4>
                    <ul class="info-list">
                        <li>✓ Miễn phí hủy phòng trước 24h</li>
                        <li>✓ Thanh toán tại khách sạn</li>
                        <li>✓ Hỗ trợ 24/7</li>
                        <li>✓ Giá đã bao gồm thuế</li>
                    </ul>
                </div>
            </aside>

            <main class="rooms-section">
                <div class="section-header-bar">
                    <h2 class="section-title">Danh Sách Phòng (@Model.Count phòng)</h2>
                    <div class="sort-controls">
                        <label for="sortBy">Sắp xếp:</label>
                        <select id="sortBy" class="sort-select">
                            <option value="default">Mặc định</option>
                            <option value="price-asc">Giá: Thấp đến cao</option>
                            <option value="price-desc">Giá: Cao đến thấp</option>
                            <option value="name">Tên phòng</option>
                        </select>
                    </div>
                </div>

                @if (Model != null && Model.Count > 0)
                {
                    <div class="rooms-list" id="roomsList">
                        @foreach (var room in Model)
                        {
                            <div class="room-item" data-price="@room.Price" data-name="@room.RoomName">
                                <div class="room-image-wrapper">
                                    <img src="@room.ImageUrl"
                                         onerror="this.src='https://via.placeholder.com/350x250/0066a1/ffffff?text=@room.RoomName'"
                                         class="room-image" />

                                    <span class="room-status @(room.Status == "Available" ? "available" : "maintenance")">
                                        @(room.Status == "Available" ? "Còn Trống" : "Bảo Trì")
                                    </span>
                                </div>

                                <div class="room-details">
                                    <div class="room-header-section">
                                        <h3 class="room-title">@room.RoomName</h3>
                                        <span class="room-location">📍 @room.Branch?.BranchName</span>
                                    </div>

                                    <p class="room-category">
                                        @if (room.RoomType == "Standard")
                                        {
                                            <text>🏨 Standard - Tiêu Chuẩn</text>
                                        }
                                        else if (room.RoomType == "Deluxe")
                                        {
                                            <text>⭐ Deluxe - Cao Cấp</text>
                                        }
                                        else if (room.RoomType == "Suite")
                                        {
                                            <text>💎 Suite - VIP</text>
                                        }
                                    </p>

                                    <p class="room-desc">
                                        👥 Sức chứa: @room.Capacity người
                                    </p>

                                    <div class="room-bottom">
                                        <div class="room-pricing">
                                            <span class="price-per-night">Giá/đêm:</span>
                                            <span class="price-amount">
                                                @room.Price.ToString("N0")₫
                                            </span>
                                        </div>

                                        @if (room.Status == "Available")
                                        {
                                            <a href="/Home/BookingDetails?roomId=@room.RoomId"
                                               class="booking-btn">
                                                Đặt Phòng Ngay
                                            </a>
                                        }
                                        else
                                        {
                                            <button class="booking-btn disabled" disabled>
                                                Không Khả Dụng
                                            </button>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div style="text-align: center; padding: 50px; background: white; border-radius: 10px; margin-top: 20px;">
                        <h3 style="color: #666;">😔 Không tìm thấy phòng phù hợp</h3>
                        <p style="color: #999;">Vui lòng thử lại với các tiêu chí tìm kiếm khác</p>
                        <a href="/Home/Booking" style="display: inline-block; margin-top: 15px; padding: 10px 30px; background: #0066a1; color: white; text-decoration: none; border-radius: 5px;">
                            Xem tất cả phòng
                        </a>
                    </div>
                }
            </main>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        // Sort functionality
        document.getElementById('sortBy').addEventListener('change', function() {
            const sortValue = this.value;
            const roomsList = document.getElementById('roomsList');
            const rooms = Array.from(roomsList.querySelectorAll('.room-item'));

            rooms.sort((a, b) => {
                switch(sortValue) {
                    case 'price-asc':
                        return parseFloat(a.dataset.price) - parseFloat(b.dataset.price);
                    case 'price-desc':
                        return parseFloat(b.dataset.price) - parseFloat(a.dataset.price);
                    case 'name':
                        return a.dataset.name.localeCompare(b.dataset.name);
                    default:
                        return 0;
                }
            });

            // Re-append sorted rooms
            rooms.forEach(room => roomsList.appendChild(room));
        });

        // Update checkout min date when checkin changes
        const checkinInput = document.querySelector('input[name="checkin"]');
        const checkoutInput = document.querySelector('input[name="checkout"]');

        if (checkinInput && checkoutInput) {
            checkinInput.addEventListener('change', function() {
                const checkinDate = new Date(this.value);
                const minCheckout = new Date(checkinDate);
                minCheckout.setDate(minCheckout.getDate() + 1);
                checkoutInput.min = minCheckout.toISOString().split('T')[0];

                // Reset checkout if it's before new min
                if (checkoutInput.value && new Date(checkoutInput.value) <= checkinDate) {
                    checkoutInput.value = '';
                }
            });
        }
    </script>
}